<div id="searchtabs" class="row">{% load i18n in_list %}{% load url from future %}
    {% comment %}<ul>
    <li><a href='#tabfilter'>{% trans "Query Options" %}</a></li>
    {% if not from_saved_query %}
    <li><a href='#tabsave'>{% trans "Save This Query" %}</a></li>
    {% endif %}
    {% if user_saved_queries %}
    <li><a href='#tabload'>{% trans "Load Saved Query" %}</a></li>
    {% endif %}
    </ul>{% endcomment %}
    <div class="panel-group filter-options" id="accordion">
        <div id='tabfilter' class="panel panel-default">
            <div class="panel-heading">
            <h3 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                {% trans "Change Query" %}
                </a>
            </h3>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in">
                <div class="panel-body">
                    <form>
                        {% csrf_token %}
                        <select name='select' id='filterBuilderSelect'>
                            <option value='Sort'>{% trans "Sorting" %}</option>
                            <option value='Owner'>{% trans "Owner" %}</option>
                            <option value='Queue'>{% trans "Queue" %}</option>
                            <option value='Status'>{% trans "Status" %}</option>
                            <option value='Keywords'>{% trans "Keywords" %}</option>
                            <option value='Dates'>{% trans "Date Range" %}</option>
                        </select>
                        <input type='button' id='filterBuilderButton' value='+' />
                    </form>

                    <form method='get' action='./'>
                        {% csrf_token %}
                        <div class='thumbnail filterBox{% if query_params.sorting %} filterBoxShow{% endif %}' id='filterBoxSort'>
                            <label for='id_sort'>{% trans "Sorting" %}</label>
                            <select id='id_sort' name='sort'>
                                <option value='created'{% if query_params.sorting == "created"%} selected='selected'{% endif %}>{% trans "Created" %}</option>
                                <option value='title'{% if query_params.sorting == "title"%} selected='selected'{% endif %}>{% trans "Title" %}</option>
                                <option value='queue'{% if query_params.sorting == "queue"%} selected='selected'{% endif %}>{% trans "Queue" %}</option>
                                <option value='status'{% if query_params.sorting == "status"%} selected='selected'{% endif %}>{% trans "Status" %}</option>
                                <option value='priority'{% if query_params.sorting == "priority"%} selected='selected'{% endif %}>{% trans "Priority" %}</option>
                                <option value='assigned_to'{% if query_params.sorting == "assigned_to"%} selected='selected'{% endif %}>{% trans "Owner" %}</option>
                            </select>
                            <label for='id_sortreverse'>{% trans "Reverse" %}</label>
                            <input type='checkbox' name='sortreverse' id='id_sortreverse'{% if query_params.sortreverse %} checked='checked'{% endif %} />
                            <p class='filterHelp'>{% trans "Ordering applied to tickets" %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <div class='thumbnail filterBox{% if query_params.filtering.assigned_to__id__in %} filterBoxShow{% endif %}' id='filterBoxOwner'>
                            <label for='id_owners'>{% trans "Owner(s)" %}</label>
                            <select id='id_owners' name='assigned_to' multiple='selected' size='5'>
                                {% for u in user_choices %}
                                <option value='{{ u.id }}'{% if u.id|in_list:query_params.filtering.assigned_to__id__in %} selected='selected'{% endif %}>
                                    {{ u.username }}{% ifequal u user %} {% trans "(ME)" %}{% endifequal %}
                                </option>
                                {% endfor %}
                            </select>
                            <p class='filterHelp'>{% trans "Ctrl-Click to select multiple options" %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <div class='thumbnail filterBox{% if query_params.filtering.queue__id__in %} filterBoxShow{% endif %}' id='filterBoxQueue'>
                            <label for='id_queues'>{% trans "Queue(s)" %}</label><select id='id_queues' name='queue' multiple='selected' size='5'>{% for q in queue_choices %}<option value='{{ q.id }}'{% if q.id|in_list:query_params.filtering.queue__id__in %} selected='selected'{% endif %}>{{ q.title }}</option>{% endfor %}</select>
                            <p class='filterHelp'>{% trans "Ctrl-click to select multiple options" %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <div class='thumbnail filterBox{% if query_params.filtering.status__in %} filterBoxShow{% endif %}' id='filterBoxStatus'>
                            <label for='id_statuses'>{% trans "Status(es)" %}</label><select id='id_statuses' name='status' multiple='selected' size='5'>{% for s in status_choices %}<option value='{{ s.0 }}'{% if s.0|in_list:query_params.filtering.status__in %} selected='selected'{% endif %}>{{ s.1 }}</option>{% endfor %}</select>
                            <p class='filterHelp'>{% trans "Ctrl-click to select multiple options" %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <div class='thumbnail filterBox{% if query_params.filtering.created__gte or query_params.filtering.created__lte %} filterBoxShow{% endif %}' id='filterBoxDates'>
                            <label for='id_date_from'>{% trans "Date (From)" %}</label><input type='text' name='date_from' value='{{ query_params.filtering.created__gte }}' id='id_date_from' />
                            <label for='id_date_to'>{% trans "Date (To)" %}</label><input type='text' name='date_to' value='{{ query_params.filtering.created__lte }}' id='id_date_to' />
                            <p class='filterHelp'>{% trans "Use YYYY-MM-DD date format, eg 2011-05-29" %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <div class='thumbnail filterBox{% if query %} filterBoxShow{% endif %}' id='filterBoxKeywords'>
                            <label for='id_query'>{% trans "Keywords" %}</label><input type='text' name='q' value='{{ query }}' id='id_query' />
                            <p class='filterHelp'>{% trans "Keywords are case-insensitive, and will be looked for in the title, body and submitter fields." %}</p>
                            <input type='button' class='filterBuilderRemove' value='-' />
                        </div>

                        <hr style='clear: both;' />

                        <input class="btn btn-primary" type='submit' value='{% trans "Apply Filter" %}' />
{% if from_saved_query %}
{% if saved_query.user == user %}
                        <p>{% blocktrans with saved_query.title as query_name %}You are currently viewing saved query <strong>"{{ query_name }}"</strong>.{% endblocktrans %} <a href='{% url 'helpdesk_delete_query' saved_query.id %}'>{% trans "Delete Saved Query" %}</a></p>
{% endif %}
                        <p>{% blocktrans with saved_query.id as query_id %}<a href='../reports/?saved_query={{ query_id }}'>Run a report</a> on this query to see stats and charts for the data listed below.{% endblocktrans %}</p>
{% endif %}
                    </form>
                </div>
            </div>
        </div>

{% if not from_saved_query %}
        <div class='panel panel-default' id='tabsave'>
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">{% trans "Save Query" %}</a>
                </h3>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse">
                <div class="panel-body">
                    <form method='post' action='{% url 'helpdesk_savequery' %}'>
                        {% csrf_token %}
                        <input type='hidden' name='query_encoded' value='{{ urlsafe_query }}' />
                        <dl>
                            <dt><label for='id_title'>{% trans "Query Name" %}</label></dt>
                            <dd><input type='text' name='title' id='id_title' /></dd>
                            <dd class='form_help_text'>{% trans "This name appears in the drop-down list of saved queries. If you share your query, other users will see this name, so choose something clear and descriptive!" %}</dd>

                            <dt><label for='id_shared'>{% trans "Shared?" %}</label></dt>
                            <dd><input type='checkbox' name='shared' id='id_shared' /> {% trans "Yes, share this query with other users." %}</dd>
                            <dd class='form_help_text'>{% trans "If you share this query, it will be visible by <em>all</em> other logged-in users." %}</dd>

                        </dl>

                        <div class='buttons'>
                            <input class="btn btn-primary" type='submit' value='{% trans "Save Query" %}'>
                        </div>
                    </form>
                </div>
            </div>
        </div>
{% endif %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">{% trans "Use Saved Query" %}</a>
                </h3>
            </div>
            <div id="collapseThree" class="panel-collapse collapse">
                <div class="panel-body">
                    <form method='get' action='{% url 'helpdesk_list' %}'>
                        {% csrf_token %}
                        <p>
                            <label for='id_query_selector'>{% trans "Query" %}</label>
                            <select name='saved_query' id='id_query_selector'>
{% for q in user_saved_queries %}
                                <option value='{{ q.id }}'>{{ q.title }}{% if q.shared %} (Shared{% ifnotequal user q.user %} by {{ q.user.username }}{% endifnotequal %}){% endif %}</option>
{% endfor %}
                            </select>
                        </p>
                        <input class="btn btn-primary" type='submit' value='{% trans "Run Query" %}'>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
